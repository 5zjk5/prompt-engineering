# 短期记忆实现

本目录包含了三种不同的短期记忆管理实现，用于在对话过程中处理消息历史记录。这些实现分别对应消息处理的前期、中期和后期阶段，帮助管理对话上下文，防止上下文窗口溢出。

## 文件说明

### delete_message.py - 后期处理
**后期消息删除实现**，使用 `@after_model` 装饰器在模型响应后删除旧消息。

主要功能：
- **后期处理**：在模型生成响应后执行消息删除
- **批量删除**：删除指定数量的最早消息
- **保留上下文**：保留最近的对话历史
- **状态管理**：使用 `RemoveMessage` 对象管理消息删除

工作流程：
1. 模型处理用户输入并生成响应
2. `delete_old_messages` 函数检查消息数量
3. 如果消息超过阈值，删除最早的消息
4. 更新对话状态

### summary_message.py - 中期处理
**中期消息汇总实现**，使用 `SummarizationMiddleware` 在对话过程中汇总旧消息。

主要功能：
- **中期处理**：在对话过程中自动汇总消息
- **智能汇总**：基于令牌数量触发汇总
- **保留策略**：可配置保留的消息数量
- **上下文压缩**：将长对话压缩为摘要

工作流程：
1. 监控对话中的令牌数量
2. 当令牌超过阈值时，触发汇总
3. 使用模型生成对话摘要
4. 保留指定数量的最新消息和摘要

### trim_message.py - 前期处理
**前期消息修剪实现**，使用 `@before_model` 装饰器在模型处理前修剪消息。

主要功能：
- **前期处理**：在模型处理输入前修剪消息
- **智能选择**：保留第一条和最后几条消息
- **完全重建**：删除所有消息后重建消息列表
- **上下文优化**：确保重要信息得到保留

工作流程：
1. 接收用户输入但尚未处理
2. `trim_messages` 函数检查消息数量
3. 如果消息超过阈值，删除所有消息
4. 重建消息列表，只保留关键消息

## 使用场景对比

| 特性 | delete_message.py | summary_message.py | trim_message.py |
|------|-------------------|-------------------|-----------------|
| 处理时机 | 模型响应后 | 对话过程中 | 模型响应前 |
| 处理方式 | 删除旧消息 | 汇总旧消息 | 修剪消息列表 |
| 上下文保留 | 保留最近消息 | 保留摘要和最新消息 | 保留首尾消息 |
| 适用场景 | 简单对话管理 | 长对话压缩 | 严格上下文控制 |
| 实现复杂度 | 低 | 中 | 中 |


